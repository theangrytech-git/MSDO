name: msdo-secret-scanning

on:
  workflow_call:
  workflow_dispatch:

jobs:
  secret-scan:
    name: MSDO Secret Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      actions: read
      security-events: write

    steps:
      - name: Checkout code
        run: |
          git clone https://github.com/${{ github.repository }} .
          git checkout ${{ github.ref_name }}

      - name: Set tool to only run secret scan
        run: echo "TOOLS=credscan" >> $GITHUB_ENV

      - name: Run Microsoft Security DevOps - Secret Scan
        uses: theangrytech-git/security-devops-action@main
        id: msdo
        with:
          tools: ${{ env.TOOLS }}

      - name: Upload alerts to GitHub code scanning
        if: github.repository_visibility == 'public'
        uses: ./.github/actions/upload-sarif
        with:
          sarif_file: ${{ steps.msdo.outputs.sarifFile }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
